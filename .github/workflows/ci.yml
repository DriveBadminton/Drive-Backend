name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      SPRING_PROFILES_ACTIVE: local-mysql
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Build with Gradle
        run: ./gradlew clean build

      - name: Build Docker image
        run: docker build -t drive-backend:${{ github.sha }} .

      - name: Configure AWS credentials
        if: ${{ env.AWS_ACCOUNT_ID != '' && env.AWS_REGION != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        if: ${{ env.AWS_ACCOUNT_ID != '' && env.AWS_REGION != '' && env.ECR_REPOSITORY != '' }}
        run: |
          aws ecr describe-repositories --repository-names "$ECR_REPOSITORY" >/dev/null 2>&1 || \
            aws ecr create-repository --repository-name "$ECR_REPOSITORY"
          aws ecr get-login-password --region "$AWS_REGION" | \
            docker login --username AWS --password-stdin "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com"

      - name: Push Docker image to ECR
        if: ${{ env.AWS_ACCOUNT_ID != '' && env.AWS_REGION != '' && env.ECR_REPOSITORY != '' }}
        run: |
          IMAGE_URI="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY"
          docker tag drive-backend:${{ github.sha }} "$IMAGE_URI:${{ github.sha }}"
          docker tag drive-backend:${{ github.sha }} "$IMAGE_URI:latest"
          docker push "$IMAGE_URI:${{ github.sha }}"
          docker push "$IMAGE_URI:latest"

      - name: Deploy to EC2 via SSM
        if: ${{ env.AWS_ACCOUNT_ID != '' && env.AWS_REGION != '' && env.ECR_REPOSITORY != '' && secrets.EC2_INSTANCE_ID != '' }}
        env:
          IMAGE_REGISTRY: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
          EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
          EC2_APP_PATH: ${{ vars.EC2_APP_PATH }}
        run: |
          if [ -z "$EC2_APP_PATH" ]; then
            EC2_APP_PATH="/home/ssm-user/Drive-Backend"
          fi

          COMMANDS=$(jq -n \
            --arg reg "$IMAGE_REGISTRY" \
            --arg repo "$ECR_REPOSITORY" \
            --arg region "$AWS_REGION" \
            --arg app "$EC2_APP_PATH" \
            '[
              "#!/bin/bash",
              "set -e",
              "aws ecr get-login-password --region \($region) | docker login --username AWS --password-stdin \($reg)",
              "docker pull \($reg)/\($repo):latest",
              "docker tag \($reg)/\($repo):latest drive-backend:latest",
              "cd \($app)",
              "docker compose down || true",
              "docker compose up -d",
              "docker image prune -f"
            ]')

          aws ssm send-command \
            --instance-ids "$EC2_INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy Drive Backend" \
            --parameters commands="$COMMANDS" \
            --region "$AWS_REGION" \
            --output text
